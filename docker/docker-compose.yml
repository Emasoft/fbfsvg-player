# docker-compose.yml - SVGPlayer Linux Development Environment
#
# Multi-architecture support for ARM64 and x86_64 builds
#
# Usage:
#   ARM64 (native on Apple Silicon):
#     docker-compose up -d dev-arm64
#     docker-compose exec dev-arm64 bash
#
#   x86_64 (emulated via QEMU on Apple Silicon):
#     docker-compose up -d dev-x64
#     docker-compose exec dev-x64 bash
#
#   Build both architectures:
#     docker-compose up -d
#     docker-compose exec dev-arm64 ./scripts/build-linux.sh
#     docker-compose exec dev-x64 ./scripts/build-linux.sh
#
#   Stop all:
#     docker-compose down

services:
  # =============================================================================
  # ARM64 Development Container (native on Apple Silicon)
  # =============================================================================
  dev-arm64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: developer
        USER_UID: 1000
        USER_GID: 1000
    platform: linux/arm64
    image: svgplayer-linux-dev:arm64
    container_name: svgplayer-dev-arm64
    hostname: svgplayer-dev-arm64

    volumes:
      - ..:/workspace:cached
      - ~/.gitconfig:/home/developer/.gitconfig:ro
      - svgplayer-bash-history-arm64:/home/developer/.bash_history_dir

    stdin_open: true
    tty: true
    shm_size: '2gb'
    working_dir: /workspace

    environment:
      - TERM=xterm-256color
      - CC=clang
      - CXX=clang++
      - SKIA_BUILD_DIR=/workspace/skia-build
      - SKIA_OUT_DIR=release-linux-arm64
      - TARGET_ARCH=arm64
      - PATH=/workspace/skia-build/depot_tools:/workspace/skia-build/src/skia/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 12G
        reservations:
          cpus: '4'
          memory: 6G

    restart: unless-stopped

  # =============================================================================
  # x86_64 Development Container (QEMU emulation on Apple Silicon)
  # Note: Build times will be slower due to emulation
  # =============================================================================
  dev-x64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: developer
        USER_UID: 1000
        USER_GID: 1000
    platform: linux/amd64
    image: svgplayer-linux-dev:x64
    container_name: svgplayer-dev-x64
    hostname: svgplayer-dev-x64

    volumes:
      - ..:/workspace:cached
      - ~/.gitconfig:/home/developer/.gitconfig:ro
      - svgplayer-bash-history-x64:/home/developer/.bash_history_dir

    stdin_open: true
    tty: true
    shm_size: '2gb'
    working_dir: /workspace

    environment:
      - TERM=xterm-256color
      - CC=clang
      - CXX=clang++
      - SKIA_BUILD_DIR=/workspace/skia-build
      - SKIA_OUT_DIR=release-linux-x64
      - TARGET_ARCH=x64
      - PATH=/workspace/skia-build/depot_tools:/workspace/skia-build/src/skia/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 12G
        reservations:
          cpus: '4'
          memory: 6G

    restart: unless-stopped

  # =============================================================================
  # Legacy alias for backward compatibility (points to ARM64)
  # =============================================================================
  dev:
    extends:
      service: dev-arm64
    container_name: svgplayer-dev
    hostname: svgplayer-dev

# =============================================================================
  # Test Runner Services (for parallel test execution)
  # Usage: docker-compose up test-arm64 test-x64
  # These containers run tests and exit, suitable for CI/CD
  # =============================================================================

  test-arm64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: developer
        USER_UID: 1000
        USER_GID: 1000
    platform: linux/arm64
    image: svgplayer-linux-dev:arm64
    container_name: svgplayer-test-arm64
    hostname: svgplayer-test-arm64

    volumes:
      - ..:/workspace:cached

    working_dir: /workspace
    shm_size: '2gb'

    environment:
      - TERM=xterm-256color
      - CC=clang
      - CXX=clang++
      - SKIA_BUILD_DIR=/workspace/skia-build
      - SKIA_OUT_DIR=release-linux-arm64
      - TARGET_ARCH=arm64
      - PATH=/workspace/skia-build/depot_tools:/workspace/skia-build/src/skia/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - OUTPUT_DIR=/workspace/build/test-results

    command: >
      bash -c "
        echo '=== SVGPlayer Linux ARM64 Test Runner ===' &&
        mkdir -p /workspace/build/test-results &&
        /workspace/scripts/run-tests-linux.sh --output-dir /workspace/build/test-results
      "

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  test-x64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: developer
        USER_UID: 1000
        USER_GID: 1000
    platform: linux/amd64
    image: svgplayer-linux-dev:x64
    container_name: svgplayer-test-x64
    hostname: svgplayer-test-x64

    volumes:
      - ..:/workspace:cached

    working_dir: /workspace
    shm_size: '2gb'

    environment:
      - TERM=xterm-256color
      - CC=clang
      - CXX=clang++
      - SKIA_BUILD_DIR=/workspace/skia-build
      - SKIA_OUT_DIR=release-linux-x64
      - TARGET_ARCH=x64
      - PATH=/workspace/skia-build/depot_tools:/workspace/skia-build/src/skia/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - OUTPUT_DIR=/workspace/build/test-results

    command: >
      bash -c "
        echo '=== SVGPlayer Linux x64 Test Runner ===' &&
        mkdir -p /workspace/build/test-results &&
        /workspace/scripts/run-tests-linux.sh --output-dir /workspace/build/test-results
      "

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

# Named volumes for persistence (separate per architecture)
volumes:
  svgplayer-bash-history-arm64:
    driver: local
  svgplayer-bash-history-x64:
    driver: local
