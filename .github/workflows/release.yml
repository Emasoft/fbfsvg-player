name: Multi-Platform Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.0)'
        required: true

defaults:
  run:
    shell: bash

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 1: Build all platforms in parallel
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: macos-arm64
            artifact: fbfsvg-player-macos-arm64
          - os: macos-13
            target: macos-x64
            artifact: fbfsvg-player-macos-x64
          - os: ubuntu-latest
            target: linux-x64
            artifact: fbfsvg-player-linux-x64
          - os: windows-latest
            target: windows-x64
            artifact: fbfsvg-player-windows-x64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.target }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # macOS Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install macOS dependencies
        if: matrix.os == 'macos-14'
        run: |
          brew install sdl2 pkg-config icu4c ninja
          echo "ICU_ROOT=$(brew --prefix icu4c)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Linux Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang ninja-build pkg-config \
            libsdl2-dev libicu-dev libgl1-mesa-dev libegl1-mesa-dev \
            libgles2-mesa-dev libfreetype6-dev libfontconfig1-dev libx11-dev \
            libvulkan-dev

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Windows Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup MSVC
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      - name: Install Windows dependencies
        if: matrix.os == 'windows-latest'
        run: |
          curl -L -o SDL2-devel.zip https://github.com/libsdl-org/SDL/releases/download/release-2.30.0/SDL2-devel-2.30.0-VC.zip
          unzip SDL2-devel.zip -d external/
          mv external/SDL2-2.30.0 external/SDL2
          curl -L -o vulkan-headers.zip https://github.com/KhronosGroup/Vulkan-Headers/archive/refs/tags/v1.3.275.zip
          unzip vulkan-headers.zip -d external/

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Cache Skia
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache Skia
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: skia-build/src/skia/out/release-${{ matrix.target }}
          key: skia-${{ matrix.target }}-${{ hashFiles('skia-build/build-*.sh', 'skia-build/build-*.bat') }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build Skia (if not cached)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Skia (macOS ARM64)
        if: steps.cache-skia.outputs.cache-hit != 'true' && matrix.os == 'macos-14'
        run: cd skia-build && ./build-macos.sh -y

      - name: Build Skia (macOS x64)
        if: steps.cache-skia.outputs.cache-hit != 'true' && matrix.os == 'macos-13'
        run: cd skia-build && ./build-macos.sh -y

      - name: Build Skia (Linux)
        if: steps.cache-skia.outputs.cache-hit != 'true' && matrix.os == 'ubuntu-latest'
        run: cd skia-build && ./build-linux.sh -y

      - name: Build Skia (Windows)
        if: steps.cache-skia.outputs.cache-hit != 'true' && matrix.os == 'windows-latest'
        run: cd skia-build && ./build-windows.bat -y

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build Player
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Player (macOS ARM64)
        if: matrix.os == 'macos-14'
        run: |
          ./scripts/build-macos.sh
          mv build/fbfsvg-player build/${{ matrix.artifact }}

      - name: Build Player (macOS x64)
        if: matrix.os == 'macos-13'
        run: |
          ./scripts/build-macos.sh
          mv build/fbfsvg-player build/${{ matrix.artifact }}

      - name: Build Player (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./scripts/build-linux.sh
          mv build/fbfsvg-player-linux-x64 build/${{ matrix.artifact }}

      - name: Build Player (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          ./scripts/build-windows.bat
          mv build/windows/svg_player_animated.exe build/${{ matrix.artifact }}.exe

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload Artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: build/${{ matrix.artifact }}*
          retention-days: 5

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 2: Create DRAFT release with all assets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  draft-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      release_id: ${{ steps.create.outputs.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Package releases
        id: package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p release

          # macOS ARM64 tarball
          cd artifacts/fbfsvg-player-macos-arm64
          chmod +x fbfsvg-player-macos-arm64
          mv fbfsvg-player-macos-arm64 fbfsvg-player
          tar -czvf ../../release/fbfsvg-player-${VERSION}-macos-arm64.tar.gz fbfsvg-player
          cd ../..

          # macOS x64 tarball (if artifact exists)
          if [ -d "artifacts/fbfsvg-player-macos-x64" ]; then
            cd artifacts/fbfsvg-player-macos-x64
            chmod +x fbfsvg-player-macos-x64
            mv fbfsvg-player-macos-x64 fbfsvg-player
            tar -czvf ../../release/fbfsvg-player-${VERSION}-macos-x64.tar.gz fbfsvg-player
            cd ../..
          fi

          # Linux x64 tarball
          cd artifacts/fbfsvg-player-linux-x64
          chmod +x fbfsvg-player-linux-x64
          mv fbfsvg-player-linux-x64 fbfsvg-player
          tar -czvf ../../release/fbfsvg-player-${VERSION}-linux-x64.tar.gz fbfsvg-player
          cd ../..

          # Linux DEB package
          mkdir -p deb/DEBIAN deb/usr/bin
          cp artifacts/fbfsvg-player-linux-x64/fbfsvg-player deb/usr/bin/
          chmod +x deb/usr/bin/fbfsvg-player
          cat > deb/DEBIAN/control << EOF
          Package: fbfsvg-player
          Version: ${VERSION#v}
          Section: graphics
          Priority: optional
          Architecture: amd64
          Maintainer: Emasoft <713559+Emasoft@users.noreply.github.com>
          Description: FBF.SVG vector video player
           High-performance animated SVG player for the FBF.SVG format.
          EOF
          dpkg-deb --build deb release/fbfsvg-player_${VERSION#v}_amd64.deb

          # Windows x64 zip
          cd artifacts/fbfsvg-player-windows-x64
          zip ../../release/fbfsvg-player-${VERSION}-windows-x64.zip fbfsvg-player-windows-x64.exe
          cd ../..

          # Generate SHA256 checksums
          cd release
          sha256sum * > SHA256SUMS.txt
          cd ..

          # Output checksums for validation
          echo "CHECKSUMS<<EOF" >> $GITHUB_OUTPUT
          cat release/SHA256SUMS.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: release/
          artifact-name: sbom-${{ steps.version.outputs.VERSION }}
          output-file: release/sbom.spdx.json
          format: spdx-json

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          path: release/
          output-file: release/sbom.cyclonedx.json
          format: cyclonedx-json

      - name: Create DRAFT GitHub Release
        id: create
        uses: softprops/action-gh-release@v1
        with:
          name: FBF.SVG Player ${{ steps.version.outputs.VERSION }}
          draft: true  # <-- DRAFT MODE: allows validation before publish
          prerelease: false
          files: release/*
          body: |
            ## FBF.SVG Player ${{ steps.version.outputs.VERSION }}

            > âš ï¸ **DRAFT RELEASE** - Pending validation. Do not use until published.

            ### Downloads

            | Platform | Package | GPU Backend |
            |----------|---------|-------------|
            | macOS (ARM64) | `fbfsvg-player-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz` | Graphite (Metal) |
            | macOS (x64) | `fbfsvg-player-${{ steps.version.outputs.VERSION }}-macos-x64.tar.gz` | Graphite (Metal) |
            | Linux (x64) | `fbfsvg-player-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz` | Graphite (Vulkan) |
            | Linux (DEB) | `fbfsvg-player_${{ steps.version.outputs.VERSION }}_amd64.deb` | Graphite (Vulkan) |
            | Windows (x64) | `fbfsvg-player-${{ steps.version.outputs.VERSION }}-windows-x64.zip` | Graphite (Vulkan) |

            ### Checksums (SHA256)

            ```
            ${{ steps.package.outputs.CHECKSUMS }}
            ```

            ### Software Bill of Materials (SBOM)

            This release includes SBOM files for supply chain security:
            - `sbom.spdx.json` (SPDX format)
            - `sbom.cyclonedx.json` (CycloneDX format)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "Created DRAFT release: ${{ steps.version.outputs.VERSION }}"
          echo "Release ID: ${{ steps.create.outputs.id }}"
          echo "Release URL: ${{ steps.create.outputs.url }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 3: Validate draft release assets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    needs: draft-release
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: echo "VERSION=${{ needs.draft-release.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Wait for assets to propagate
        run: sleep 10

      - name: Download and validate all assets
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BASE_URL="https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}"

          echo "=== Downloading release assets ==="
          mkdir -p downloads
          cd downloads

          # Download all assets
          for asset in \
            "fbfsvg-player-${VERSION}-macos-arm64.tar.gz" \
            "fbfsvg-player-${VERSION}-macos-x64.tar.gz" \
            "fbfsvg-player-${VERSION}-linux-x64.tar.gz" \
            "fbfsvg-player_${VERSION#v}_amd64.deb" \
            "fbfsvg-player-${VERSION}-windows-x64.zip" \
            "sbom.spdx.json" \
            "sbom.cyclonedx.json" \
            "SHA256SUMS.txt"
          do
            echo "Downloading: $asset"
            curl -fsSL -o "$asset" "${BASE_URL}/${asset}" || {
              echo "ERROR: Failed to download $asset"
              exit 1
            }
          done

          echo ""
          echo "=== Verifying SHA256 checksums ==="
          # Verify checksums match
          sha256sum -c SHA256SUMS.txt || {
            echo "ERROR: Checksum verification failed!"
            exit 1
          }

          echo ""
          echo "=== Validating archive contents ==="

          # Validate macOS ARM64 tarball
          echo "Checking macOS ARM64 tarball..."
          tar -tzf "fbfsvg-player-${VERSION}-macos-arm64.tar.gz" | grep -q "fbfsvg-player" || {
            echo "ERROR: macOS ARM64 tarball missing fbfsvg-player binary"
            exit 1
          }

          # Validate macOS x64 tarball
          echo "Checking macOS x64 tarball..."
          tar -tzf "fbfsvg-player-${VERSION}-macos-x64.tar.gz" | grep -q "fbfsvg-player" || {
            echo "ERROR: macOS x64 tarball missing fbfsvg-player binary"
            exit 1
          }

          # Validate Linux tarball
          echo "Checking Linux tarball..."
          tar -tzf "fbfsvg-player-${VERSION}-linux-x64.tar.gz" | grep -q "fbfsvg-player" || {
            echo "ERROR: Linux tarball missing fbfsvg-player binary"
            exit 1
          }

          # Validate DEB package
          echo "Checking DEB package..."
          dpkg-deb -c "fbfsvg-player_${VERSION#v}_amd64.deb" | grep -q "usr/bin/fbfsvg-player" || {
            echo "ERROR: DEB package missing fbfsvg-player binary"
            exit 1
          }

          # Validate Windows zip
          echo "Checking Windows zip..."
          unzip -l "fbfsvg-player-${VERSION}-windows-x64.zip" | grep -q ".exe" || {
            echo "ERROR: Windows zip missing .exe binary"
            exit 1
          }

          echo ""
          echo "=== Testing Linux binary execution ==="
          tar -xzf "fbfsvg-player-${VERSION}-linux-x64.tar.gz"
          chmod +x fbfsvg-player
          ./fbfsvg-player --help 2>&1 | head -5 || true  # May fail without display, that's OK

          echo ""
          echo "âœ… All validations passed!"

      - name: Report validation success
        run: |
          echo "::notice::Release ${{ steps.version.outputs.VERSION }} validated successfully"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 4: Publish release (convert draft to public)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    needs: [draft-release, validate]
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.publish.outputs.published }}

    steps:
      - name: Get version
        id: version
        run: echo "VERSION=${{ needs.draft-release.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Publish release (remove draft status)
        id: publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          echo "Publishing release ${VERSION}..."

          # Update release: remove draft status, update body
          gh release edit "${VERSION}" \
            --draft=false \
            --notes "## FBF.SVG Player ${VERSION}

          ### Downloads

          | Platform | Package | GPU Backend |
          |----------|---------|-------------|
          | macOS (ARM64) | \`fbfsvg-player-${VERSION}-macos-arm64.tar.gz\` | Graphite (Metal) |
          | macOS (x64) | \`fbfsvg-player-${VERSION}-macos-x64.tar.gz\` | Graphite (Metal) |
          | Linux (x64) | \`fbfsvg-player-${VERSION}-linux-x64.tar.gz\` | Graphite (Vulkan) |
          | Linux (DEB) | \`fbfsvg-player_${VERSION#v}_amd64.deb\` | Graphite (Vulkan) |
          | Windows (x64) | \`fbfsvg-player-${VERSION}-windows-x64.zip\` | Graphite (Vulkan) |

          ### Installation

          **macOS (Homebrew):**
          \`\`\`bash
          brew tap Emasoft/fbfsvg-player
          brew install fbfsvg-player
          \`\`\`

          **Linux (APT):**
          \`\`\`bash
          wget https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player_${VERSION#v}_amd64.deb
          sudo dpkg -i fbfsvg-player_${VERSION#v}_amd64.deb
          \`\`\`

          **Linux (Tarball):**
          \`\`\`bash
          wget https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player-${VERSION}-linux-x64.tar.gz
          tar -xzf fbfsvg-player-${VERSION}-linux-x64.tar.gz
          ./fbfsvg-player animation.fbf.svg
          \`\`\`

          **Windows (Scoop):**
          \`\`\`powershell
          scoop bucket add fbfsvg-player https://github.com/Emasoft/fbfsvg-player
          scoop install fbfsvg-player
          \`\`\`

          ### Checksums

          See \`SHA256SUMS.txt\` in release assets for verification.

          ### Software Bill of Materials (SBOM)

          This release includes SBOM files for supply chain security:
          - \`sbom.spdx.json\` (SPDX format)
          - \`sbom.cyclonedx.json\` (CycloneDX format)
          "

          echo "published=true" >> $GITHUB_OUTPUT
          echo "âœ… Release ${VERSION} is now PUBLIC"

      - name: Verify release is public
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Verify draft status is false
          IS_DRAFT=$(gh release view "${VERSION}" --json isDraft --jq '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            echo "ERROR: Release is still a draft!"
            exit 1
          fi

          echo "âœ… Confirmed: Release ${VERSION} is published (not draft)"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 5: Update package manifests (only after publish)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-packages:
    needs: [draft-release, publish]
    runs-on: ubuntu-latest
    if: needs.publish.outputs.published == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version and hashes
        id: info
        run: |
          VERSION=${{ needs.draft-release.outputs.version }}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          BASE_URL="https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}"

          curl -sL "${BASE_URL}/fbfsvg-player-${VERSION}-macos-arm64.tar.gz" -o macos-arm64.tar.gz
          echo "MACOS_ARM64_SHA256=$(sha256sum macos-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

          curl -sL "${BASE_URL}/fbfsvg-player-${VERSION}-macos-x64.tar.gz" -o macos-x64.tar.gz
          echo "MACOS_X64_SHA256=$(sha256sum macos-x64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

          curl -sL "${BASE_URL}/fbfsvg-player-${VERSION}-linux-x64.tar.gz" -o linux.tar.gz
          echo "LINUX_SHA256=$(sha256sum linux.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

          curl -sL "${BASE_URL}/fbfsvg-player-${VERSION}-windows-x64.zip" -o windows.zip
          echo "WINDOWS_SHA256=$(sha256sum windows.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update package manifests
        run: |
          VERSION=${{ steps.info.outputs.VERSION }}
          MACOS_ARM64_SHA=${{ steps.info.outputs.MACOS_ARM64_SHA256 }}
          MACOS_X64_SHA=${{ steps.info.outputs.MACOS_X64_SHA256 }}
          LINUX_SHA=${{ steps.info.outputs.LINUX_SHA256 }}
          WINDOWS_SHA=${{ steps.info.outputs.WINDOWS_SHA256 }}

          # Update macOS Homebrew formula (supports both ARM64 and x64)
          cat > Formula/fbfsvg-player.rb << EOF
          # Homebrew formula for fbfsvg-player (macOS ARM64 and Intel x86_64)
          class FbfsvgPlayer < Formula
            desc "High-performance animated SVG player for the FBF.SVG vector video format"
            homepage "https://github.com/Emasoft/fbfsvg-player"
            license "BSD-3-Clause"
            version "${VERSION#v}"

            on_arm do
              url "https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player-${VERSION}-macos-arm64.tar.gz"
              sha256 "${MACOS_ARM64_SHA}"
            end

            on_intel do
              url "https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player-${VERSION}-macos-x64.tar.gz"
              sha256 "${MACOS_X64_SHA}"
            end

            def install
              bin.install "fbfsvg-player"
            end

            test do
              assert_match "FBF.SVG Player", shell_output("#{bin}/fbfsvg-player --help 2>&1", 1)
            end
          end
          EOF

          # Update Linux Homebrew formula
          cat > Formula/fbfsvg-player@linux.rb << EOF
          # Homebrew/Linuxbrew formula for fbfsvg-player (Linux x64)
          class FbfsvgPlayerAtLinux < Formula
            desc "High-performance animated SVG player for the FBF.SVG vector video format"
            homepage "https://github.com/Emasoft/fbfsvg-player"
            url "https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player-${VERSION}-linux-x64.tar.gz"
            sha256 "${LINUX_SHA}"
            license "BSD-3-Clause"
            version "${VERSION#v}"

            depends_on :linux
            depends_on arch: :x86_64

            def install
              bin.install "fbfsvg-player"
            end

            test do
              assert_match "FBF.SVG Player", shell_output("#{bin}/fbfsvg-player --help 2>&1", 1)
            end
          end
          EOF

          # Update Scoop manifest
          cat > bucket/fbfsvg-player.json << EOF
          {
              "\$schema": "https://raw.githubusercontent.com/ScoopInstaller/Scoop/master/schema.json",
              "version": "${VERSION#v}",
              "description": "High-performance animated SVG player for the FBF.SVG vector video format",
              "homepage": "https://github.com/Emasoft/fbfsvg-player",
              "license": "BSD-3-Clause",
              "architecture": {
                  "64bit": {
                      "url": "https://github.com/Emasoft/fbfsvg-player/releases/download/${VERSION}/fbfsvg-player-${VERSION}-windows-x64.zip",
                      "hash": "${WINDOWS_SHA}"
                  }
              },
              "bin": "fbfsvg-player.exe",
              "checkver": "github",
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/Emasoft/fbfsvg-player/releases/download/v\$version/fbfsvg-player-v\$version-windows-x64.zip"
                      }
                  }
              }
          }
          EOF

      - name: Commit updated manifests
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/ bucket/
          git commit -m "Update package manifests to ${{ steps.info.outputs.VERSION }}" || echo "No changes"
          git push

      - name: Summary
        run: |
          echo "### Release Published Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.info.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manifests Updated:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`Formula/fbfsvg-player.rb\` (Homebrew macOS)" >> $GITHUB_STEP_SUMMARY
          echo "- \`Formula/fbfsvg-player@linux.rb\` (Linuxbrew)" >> $GITHUB_STEP_SUMMARY
          echo "- \`bucket/fbfsvg-player.json\` (Scoop Windows)" >> $GITHUB_STEP_SUMMARY
