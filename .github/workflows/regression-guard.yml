name: Regression Guard

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  regression-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: macos
          - os: ubuntu-24.04
            platform: linux
          - os: windows-2022
            platform: windows
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Build Environment
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "macos" ]]; then
            brew install jq || true
          elif [[ "${{ matrix.platform }}" == "linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y jq build-essential clang ninja-build pkg-config \
              libsdl2-dev libgl1-mesa-dev libegl1-mesa-dev libfreetype6-dev \
              libfontconfig1-dev libicu-dev libpng-dev libjpeg-dev libwebp-dev
          elif [[ "${{ matrix.platform }}" == "windows" ]]; then
            # jq is pre-installed on windows-2022 runners
            echo "Windows environment ready"
          fi

      - name: Build Test Suite
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            # Windows build using scripts/build-windows.bat
            # Test suite build for Windows may differ
            echo "Windows test build - using pre-built artifacts"
          else
            make test-build
          fi

      - name: Run Automated Tests
        id: tests
        continue-on-error: true
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            # Windows-specific test runner
            ./scripts/run_test_cycle.sh --skip-build 2>&1 | tee test-output.log || true
            TEST_EXIT_CODE=${PIPESTATUS[0]:-0}
          else
            # Run tests and capture exit code properly (PIPESTATUS[0] gets exit code of first command in pipeline)
            set -o pipefail
            ./scripts/run_test_cycle.sh --skip-build 2>&1 | tee test-output.log
            TEST_EXIT_CODE=${PIPESTATUS[0]}
          fi
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          exit ${TEST_EXIT_CODE}

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-report-${{ matrix.platform }}-${{ github.sha }}
          path: |
            test-report.json
            test-output.log
          retention-days: 30

      - name: Block PR on Regression
        if: github.event_name == 'pull_request' && steps.tests.outputs.exit_code != '0'
        shell: bash
        run: |
          echo "::error::REGRESSION DETECTED - PR cannot be merged"
          echo "Review test-report.json for details"
          exit 1

      - name: Auto-Revert Main on Regression
        if: github.event_name == 'push' && steps.tests.outputs.exit_code != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # Get commit info
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo $COMMIT_SHA | cut -c1-7)

          # Get last known good commit
          PLATFORM=$(uname -m)
          BASELINE_DIR="tests/baselines/${{ matrix.platform }}_${PLATFORM}"
          LAST_GOOD=$(cat "${BASELINE_DIR}/commit_hash.txt" 2>/dev/null || echo "unknown")

          # Create GitHub issue
          gh issue create \
            --title "REGRESSION: Auto-reverted ${COMMIT_SHORT}" \
            --body "## Regression Detected

**Bad Commit:** ${COMMIT_SHA}
**Last Good Commit:** ${LAST_GOOD}

### Actions Taken
1. This issue was auto-created
2. Main branch was reverted to last known good commit

### Investigation Steps
1. Review the [test report artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
2. Checkout the bad commit locally and debug
3. Submit a fix as a new PR

### Test Output
\`\`\`
$(tail -50 test-output.log)
\`\`\`" \
            --label "regression,automated,priority-high"

          # Revert to last good commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [[ "${LAST_GOOD}" != "unknown" ]]; then
            git revert --no-commit ${COMMIT_SHA}
            git commit -m "Revert regression: ${COMMIT_SHORT}

This reverts commit ${COMMIT_SHA} which caused test regressions.
See issue for details."
            git push origin main
          else
            echo "::warning::Cannot auto-revert: no baseline commit found"
          fi

      - name: Update Baselines on Improvement
        if: github.event_name == 'push' && steps.tests.outputs.exit_code == '0'
        shell: bash
        run: |
          if ./scripts/check_improvements.sh test-report.json 2>/dev/null; then
            echo "Performance improved, updating baselines"

            PLATFORM=$(uname -m)
            BASELINE_DIR="tests/baselines/${{ matrix.platform }}_${PLATFORM}"
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            # Update baselines with proper format (version, timestamp, platform, metrics)
            jq --arg ts "${TIMESTAMP}" --arg plat "${{ matrix.platform }}_${PLATFORM}" \
              '{version: 1, timestamp: $ts, platform: $plat, metrics: .metrics}' \
              test-report.json > "${BASELINE_DIR}/performance.json"
            git rev-parse HEAD > "${BASELINE_DIR}/commit_hash.txt"

            # Commit changes
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "${BASELINE_DIR}/"
            git commit -m "Update baselines: performance improved [skip ci]"
            git push origin main
          else
            echo "No significant improvement, baselines unchanged"
          fi

      - name: Post Summary
        if: always()
        shell: bash
        run: |
          if [[ -f test-report.json ]]; then
            TOTAL=$(jq -r '.summary.total // 0' test-report.json)
            PASSED=$(jq -r '.summary.passed // 0' test-report.json)
            FAILED=$(jq -r '.summary.failed // 0' test-report.json)

            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
          fi
