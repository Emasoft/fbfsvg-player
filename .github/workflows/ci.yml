name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Quick API Header Compilation Test (runs on all platforms)
  # ==========================================================================
  api-compile-test:
    name: API Header Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile API Header Test
        run: |
          # Compile-only test (-c) - verifies API header syntax without linking
          clang++ -std=c++17 \
            -I shared \
            -Wall -Wextra -Werror \
            -c tests/test_api_compile.cpp \
            -o test_api_compile.o
          echo "API header compilation: SUCCESS"

  # ==========================================================================
  # Linux Build and Test
  # ==========================================================================
  linux-build:
    name: Linux Build
    runs-on: ubuntu-24.04
    needs: api-compile-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            lld \
            ninja-build \
            python3 \
            git \
            curl \
            pkg-config \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libegl1-mesa-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxext-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libharfbuzz-dev \
            libicu-dev \
            libpng-dev \
            libjpeg-dev \
            libwebp-dev \
            libsdl2-dev

      - name: Cache Skia Build
        id: cache-skia
        uses: actions/cache@v4
        with:
          # Cache output AND all headers (full module dirs since some headers are in utils/)
          # Also include src/ for internal headers and modules needed by svg
          path: |
            skia-build/src/skia/out/release-linux-${{ runner.arch == 'X64' && 'x64' || 'arm64' }}
            skia-build/src/skia/include
            skia-build/src/skia/src
            skia-build/src/skia/modules/svg
            skia-build/src/skia/modules/skparagraph
            skia-build/src/skia/modules/skshaper
            skia-build/src/skia/modules/skunicode
            skia-build/src/skia/modules/skresources
            skia-build/src/skia/modules/skcms
          key: skia-linux-${{ runner.arch }}-v5-${{ hashFiles('skia-build/build-linux.sh') }}

      - name: Build Skia (if not cached)
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          cd skia-build
          ./build-linux.sh -y
        timeout-minutes: 30

      - name: Build Linux SDK
        run: ./scripts/build-linux-sdk.sh -y

      - name: Verify Linux Library
        run: |
          echo "Checking library exists..."
          ls -la build/linux/

          echo "Verifying ELF format..."
          file build/linux/libfbfsvgplayer.so

          echo "Checking exported symbols..."
          nm -D build/linux/libfbfsvgplayer.so | grep -E "FBFSVGPlayer_" | head -20

          echo "Verifying key symbols..."
          nm -D build/linux/libfbfsvgplayer.so | grep -q "FBFSVGPlayer_Create"
          nm -D build/linux/libfbfsvgplayer.so | grep -q "FBFSVGPlayer_Destroy"
          nm -D build/linux/libfbfsvgplayer.so | grep -q "FBFSVGPlayer_LoadSVG"

      - name: Smoke Test
        run: |
          echo "Testing shared library loads..."
          # Create minimal test program
          cat > /tmp/test.c << 'EOF'
          #include <stdio.h>
          #include <dlfcn.h>
          int main() {
              void* lib = dlopen("./build/linux/libfbfsvgplayer.so", RTLD_NOW);
              if (!lib) { printf("FAIL: %s\n", dlerror()); return 1; }
              void* sym = dlsym(lib, "FBFSVGPlayer_Create");
              if (!sym) { printf("FAIL: Symbol not found\n"); return 1; }
              printf("SUCCESS: Library loads and FBFSVGPlayer_Create found\n");
              dlclose(lib);
              return 0;
          }
          EOF
          gcc /tmp/test.c -ldl -o /tmp/test && /tmp/test

      - name: Runtime Test - SVG Loading
        run: |
          echo "Creating test SVG file..."
          cat > /tmp/test.svg << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect id="frame" width="100" height="100">
              <animate attributeName="fill" dur="1s" repeatCount="indefinite"
                       values="red;blue;green;red"/>
            </rect>
          </svg>
          EOF

          echo "Creating runtime test program..."
          cat > /tmp/runtime_test.c << 'EOF'
          #include <stdio.h>
          #include <dlfcn.h>

          typedef void* FBFSVGPlayerRef;
          typedef FBFSVGPlayerRef (*CreateFunc)(void);
          typedef void (*DestroyFunc)(FBFSVGPlayerRef);
          typedef int (*LoadSVGFunc)(FBFSVGPlayerRef, const char*);
          typedef int (*GetTotalFramesFunc)(FBFSVGPlayerRef);
          typedef int (*GetWidthFunc)(FBFSVGPlayerRef);
          typedef int (*GetHeightFunc)(FBFSVGPlayerRef);

          int main() {
              printf("Loading library...\n");
              void* lib = dlopen("./build/linux/libfbfsvgplayer.so", RTLD_NOW);
              if (!lib) { printf("FAIL: %s\n", dlerror()); return 1; }

              CreateFunc create = (CreateFunc)dlsym(lib, "FBFSVGPlayer_Create");
              DestroyFunc destroy = (DestroyFunc)dlsym(lib, "FBFSVGPlayer_Destroy");
              LoadSVGFunc load = (LoadSVGFunc)dlsym(lib, "FBFSVGPlayer_LoadSVG");
              GetTotalFramesFunc frames = (GetTotalFramesFunc)dlsym(lib, "FBFSVGPlayer_GetTotalFrames");
              GetWidthFunc getWidth = (GetWidthFunc)dlsym(lib, "FBFSVGPlayer_GetWidth");
              GetHeightFunc getHeight = (GetHeightFunc)dlsym(lib, "FBFSVGPlayer_GetHeight");

              if (!create || !destroy || !load || !frames) {
                  printf("FAIL: Missing core symbols\n");
                  if (!create) printf("  - FBFSVGPlayer_Create not found\n");
                  if (!destroy) printf("  - FBFSVGPlayer_Destroy not found\n");
                  if (!load) printf("  - FBFSVGPlayer_LoadSVG not found\n");
                  if (!frames) printf("  - FBFSVGPlayer_GetTotalFrames not found\n");
                  return 1;
              }

              printf("Creating player instance...\n");
              FBFSVGPlayerRef player = create();
              if (!player) { printf("FAIL: Create returned null\n"); return 1; }

              printf("Loading SVG file...\n");
              if (!load(player, "/tmp/test.svg")) {
                  printf("FAIL: LoadSVG returned false\n");
                  destroy(player);
                  return 1;
              }

              int totalFrames = frames(player);
              printf("Total frames: %d\n", totalFrames);

              if (getWidth && getHeight) {
                  int w = getWidth(player);
                  int h = getHeight(player);
                  printf("SVG dimensions: %dx%d\n", w, h);
              }

              printf("Destroying player...\n");
              destroy(player);
              dlclose(lib);

              printf("SUCCESS: Runtime test passed!\n");
              return 0;
          }
          EOF

          echo "Compiling runtime test..."
          gcc /tmp/runtime_test.c -ldl -o /tmp/runtime_test

          echo "Running runtime test..."
          /tmp/runtime_test

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-sdk
          path: |
            build/linux/libfbfsvgplayer.so*
            build/linux/svg_player.h
            build/linux/fbfsvgplayer.pc

  # ==========================================================================
  # macOS Build and Test
  # ==========================================================================
  macos-build:
    name: macOS Build
    runs-on: macos-14
    needs: api-compile-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install ninja pkg-config sdl2

      - name: Cache Skia Build
        id: cache-skia
        uses: actions/cache@v4
        with:
          # Cache output AND all headers (full module dirs since some headers are in utils/)
          # Also include src/ for internal headers and modules needed by svg
          path: |
            skia-build/src/skia/out/release-macos
            skia-build/src/skia/include
            skia-build/src/skia/src
            skia-build/src/skia/modules/svg
            skia-build/src/skia/modules/skparagraph
            skia-build/src/skia/modules/skshaper
            skia-build/src/skia/modules/skunicode
            skia-build/src/skia/modules/skresources
            skia-build/src/skia/modules/skcms
          key: skia-macos-arm64-v5-${{ hashFiles('skia-build/build-macos.sh') }}

      - name: Build Skia (if not cached)
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          cd skia-build
          # macOS build script has no interactive prompts, no -y needed
          ./build-macos.sh
        timeout-minutes: 30

      - name: Build macOS Desktop Player
        run: ./scripts/build-macos.sh -y

      - name: Verify macOS Binary
        run: |
          echo "Checking binary exists..."
          ls -la build/

          echo "Verifying Mach-O format..."
          file build/fbfsvg-player

          echo "Checking dependencies..."
          otool -L build/fbfsvg-player | head -10

      - name: Smoke Test - Help
        run: |
          echo "Testing --help flag..."
          ./build/fbfsvg-player --help 2>&1 || true

      - name: Smoke Test - Version
        run: |
          echo "Testing --version flag..."
          ./build/fbfsvg-player --version 2>&1 || true

      - name: Runtime Test - SVG Playback
        run: |
          echo "Creating test SVG file..."
          cat > /tmp/test.svg << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect id="frame" width="100" height="100">
              <animate attributeName="fill" dur="1s" repeatCount="indefinite"
                       values="red;blue;green;red"/>
            </rect>
          </svg>
          EOF

          echo "Running player with benchmark mode..."
          # Run with benchmark flag for 5 frames and exit
          # The player should load the SVG, render frames, and exit cleanly
          timeout 30 ./build/fbfsvg-player --benchmark=5 /tmp/test.svg || EXIT_CODE=$?

          # Check if player exited normally (0) or via timeout (124)
          if [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo "SUCCESS: Player completed benchmark mode"
          elif [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo "WARNING: Player timed out (may indicate hang)"
            exit 1
          else
            echo "FAIL: Player exited with code ${EXIT_CODE}"
            exit 1
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-player
          path: build/fbfsvg-player

  # ==========================================================================
  # macOS x64 Build and Test
  # ==========================================================================
  macos-x64-build:
    name: macOS x64 Build
    # macos-13 was retired Dec 2024. macos-15-large provides x64 but requires GitHub paid plan.
    # For now, skip x64 build - ARM64 is primary target. Uncomment when x64 runner is available.
    if: false  # Disabled: no free x64 macOS runner available
    runs-on: macos-15-large  # Intel (x64) runner - requires paid plan
    needs: api-compile-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install ninja pkg-config sdl2

      - name: Cache Skia Build
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: |
            skia-build/src/skia/out/release-macos
            skia-build/src/skia/include
            skia-build/src/skia/src
            skia-build/src/skia/modules/svg
            skia-build/src/skia/modules/skparagraph
            skia-build/src/skia/modules/skshaper
            skia-build/src/skia/modules/skunicode
            skia-build/src/skia/modules/skresources
            skia-build/src/skia/modules/skcms
          key: skia-macos-x64-v5-${{ hashFiles('skia-build/build-macos.sh') }}

      - name: Build Skia (if not cached)
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          cd skia-build
          ./build-macos.sh
        timeout-minutes: 45

      - name: Build macOS Desktop Player
        run: ./scripts/build-macos.sh -y

      - name: Verify macOS x64 Binary
        run: |
          echo "Checking binary exists..."
          ls -la build/

          echo "Verifying Mach-O format and architecture..."
          file build/fbfsvg-player
          lipo -info build/fbfsvg-player

          echo "Checking dependencies..."
          otool -L build/fbfsvg-player | head -10

      - name: Smoke Test - Help
        run: |
          echo "Testing --help flag..."
          ./build/fbfsvg-player --help 2>&1 || true

      - name: Smoke Test - Version
        run: |
          echo "Testing --version flag..."
          ./build/fbfsvg-player --version 2>&1 || true

      - name: Runtime Test - SVG Playback
        run: |
          echo "Creating test SVG file..."
          cat > /tmp/test.svg << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect id="frame" width="100" height="100">
              <animate attributeName="fill" dur="1s" repeatCount="indefinite"
                       values="red;blue;green;red"/>
            </rect>
          </svg>
          EOF

          echo "Running player with benchmark mode..."
          # Run with benchmark flag for 5 frames and exit
          # The player should load the SVG, render frames, and exit cleanly
          timeout 30 ./build/fbfsvg-player --benchmark=5 /tmp/test.svg || EXIT_CODE=$?

          # Check if player exited normally (0) or via timeout (124)
          if [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo "SUCCESS: Player completed benchmark mode"
          elif [ "${EXIT_CODE:-0}" -eq 124 ]; then
            echo "WARNING: Player timed out (may indicate hang)"
            exit 1
          else
            echo "FAIL: Player exited with code ${EXIT_CODE}"
            exit 1
          fi

      - name: Upload macOS x64 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-player
          path: build/fbfsvg-player

  # ==========================================================================
  # iOS Build
  # ==========================================================================
  ios-build:
    name: iOS Build
    runs-on: macos-14
    needs: api-compile-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Skia iOS Build
        id: cache-skia-ios
        uses: actions/cache@v4
        with:
          # Cache output AND all headers (full module dirs since some headers are in utils/)
          # Also include src/ for internal headers and modules needed by svg
          path: |
            skia-build/src/skia/out/release-ios-device
            skia-build/src/skia/out/release-ios-simulator
            skia-build/src/skia/include
            skia-build/src/skia/src
            skia-build/src/skia/modules/svg
            skia-build/src/skia/modules/skparagraph
            skia-build/src/skia/modules/skshaper
            skia-build/src/skia/modules/skunicode
            skia-build/src/skia/modules/skresources
            skia-build/src/skia/modules/skcms
          key: skia-ios-v5-${{ hashFiles('skia-build/build-ios.sh', 'skia-build/build-ios-arch.sh') }}

      - name: Build Skia iOS Device (if not cached)
        if: steps.cache-skia-ios.outputs.cache-hit != 'true'
        run: |
          cd skia-build
          # Build device first (arm64)
          ./build-ios.sh --device
          # Check if build succeeded
          if [ ! -f "src/skia/out/release-ios-device/libskia.a" ]; then
            echo "ERROR: iOS device build failed!"
            exit 1
          fi
        timeout-minutes: 30

      - name: Build Skia iOS Simulator (if not cached)
        if: steps.cache-skia-ios.outputs.cache-hit != 'true'
        run: |
          cd skia-build
          # Build simulator for current architecture (arm64 on macos-14)
          ./build-ios.sh --simulator
          # Check if build succeeded
          if [ ! -f "src/skia/out/release-ios-simulator/libskia.a" ]; then
            echo "ERROR: iOS simulator build failed!"
            exit 1
          fi
        timeout-minutes: 30

      - name: Build iOS XCFramework
        run: ./scripts/build-ios-framework.sh -y

      - name: Verify iOS XCFramework
        run: |
          echo "Checking XCFramework exists..."
          ls -la build/

          echo "Checking XCFramework structure..."
          ls -la build/FBFSVGPlayer.xcframework/

          echo "Verifying Info.plist..."
          cat build/FBFSVGPlayer.xcframework/Info.plist

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcframework
          path: build/FBFSVGPlayer.xcframework

  # ==========================================================================
  # Windows Build and Test
  # ==========================================================================
  windows-build:
    name: Windows Build
    runs-on: windows-2022
    needs: api-compile-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download SDL2
        shell: pwsh
        run: |
          # Download SDL2 development libraries
          $SDL2_VERSION = "2.30.0"
          $SDL2_URL = "https://github.com/libsdl-org/SDL/releases/download/release-$SDL2_VERSION/SDL2-devel-$SDL2_VERSION-VC.zip"
          $SDL2_ZIP = "SDL2-devel.zip"

          Write-Host "Downloading SDL2 $SDL2_VERSION..."
          Invoke-WebRequest -Uri $SDL2_URL -OutFile $SDL2_ZIP

          Write-Host "Extracting SDL2..."
          Expand-Archive -Path $SDL2_ZIP -DestinationPath .

          # Move to expected location (Move-Item handles paths correctly, unlike Rename-Item)
          Move-Item -Path "SDL2-$SDL2_VERSION" -Destination "external\SDL2"

          Write-Host "SDL2 installed at: $PWD\external\SDL2"
          Get-ChildItem "external\SDL2"

      - name: Cache Skia Build
        id: cache-skia
        uses: actions/cache@v4
        with:
          # Cache output AND all headers (full module dirs since some headers are in utils/)
          # Also include src/ for internal headers and modules needed by svg
          path: |
            skia-build/src/skia/out/release-windows
            skia-build/src/skia/include
            skia-build/src/skia/src
            skia-build/src/skia/modules/svg
            skia-build/src/skia/modules/skparagraph
            skia-build/src/skia/modules/skshaper
            skia-build/src/skia/modules/skunicode
            skia-build/src/skia/modules/skresources
            skia-build/src/skia/modules/skcms
          key: skia-windows-x64-v5-${{ hashFiles('skia-build/build-windows.bat', 'scripts/build-windows.bat') }}

      - name: Build Skia (if not cached)
        if: steps.cache-skia.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd skia-build
          call build-windows.bat /y
        timeout-minutes: 45

      - name: Fix Skia Output Path
        if: steps.cache-skia.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Windows gclient sometimes puts Skia at D:\src\skia instead of relative path
          # Check if Skia output is at the unexpected location and move it
          $unexpectedPath = "D:\src\skia\out\release-windows"
          $expectedPath = "skia-build\src\skia\out\release-windows"

          # Also handle headers if they're at D:\src\skia
          $unexpectedSkiaRoot = "D:\src\skia"
          $expectedSkiaRoot = "skia-build\src\skia"

          if (Test-Path $unexpectedPath) {
            Write-Host "Skia output found at $unexpectedPath, moving to expected location..."

            # Create parent directories
            New-Item -ItemType Directory -Force -Path "skia-build\src\skia\out" | Out-Null

            # Move the output directory
            if (Test-Path $expectedPath) {
              Remove-Item -Recurse -Force $expectedPath
            }
            Move-Item -Path $unexpectedPath -Destination $expectedPath

            Write-Host "Moved Skia output to: $expectedPath"
            Get-ChildItem $expectedPath | Select-Object -First 10

            # Also move headers, modules, and src if needed
            if ((Test-Path "$unexpectedSkiaRoot\include") -and !(Test-Path "$expectedSkiaRoot\include")) {
              Write-Host "Moving Skia headers..."
              Copy-Item -Recurse -Force "$unexpectedSkiaRoot\include" "$expectedSkiaRoot\include"
            }
            if ((Test-Path "$unexpectedSkiaRoot\modules") -and !(Test-Path "$expectedSkiaRoot\modules")) {
              Write-Host "Moving Skia modules..."
              Copy-Item -Recurse -Force "$unexpectedSkiaRoot\modules" "$expectedSkiaRoot\modules"
            }
            if ((Test-Path "$unexpectedSkiaRoot\src") -and !(Test-Path "$expectedSkiaRoot\src")) {
              Write-Host "Moving Skia src (internal headers)..."
              Copy-Item -Recurse -Force "$unexpectedSkiaRoot\src" "$expectedSkiaRoot\src"
            }
          } elseif (Test-Path $expectedPath) {
            Write-Host "Skia output already at expected location: $expectedPath"
            # Verify library file exists (Windows uses skia.lib, not libskia.lib)
            if (Test-Path "$expectedPath\skia.lib") {
              Write-Host "Found skia.lib"
            } else {
              Write-Host "WARNING: skia.lib not found!"
              Write-Host "Library files in $expectedPath :"
              Get-ChildItem "$expectedPath\*.lib" -ErrorAction SilentlyContinue | Select-Object Name
            }
          } else {
            Write-Host "ERROR: Skia output not found at either location"
            Write-Host "Checking D:\src..."
            if (Test-Path "D:\src") { Get-ChildItem "D:\src" -Recurse -Depth 3 | Select-Object -First 20 }
            Write-Host "Checking skia-build\src..."
            if (Test-Path "skia-build\src") { Get-ChildItem "skia-build\src" -Recurse -Depth 3 | Select-Object -First 20 }
            exit 1
          }

      - name: Build Windows Player
        shell: cmd
        run: |
          call scripts\build-windows.bat /y

      - name: Verify Windows Binary
        shell: pwsh
        run: |
          Write-Host "Checking binary exists..."
          Get-ChildItem "build\windows"

          Write-Host ""
          Write-Host "Verifying PE format..."
          $exe = "build\windows\fbfsvg-player.exe"
          if (Test-Path $exe) {
            $fileInfo = Get-Item $exe
            Write-Host "File: $($fileInfo.Name)"
            Write-Host "Size: $($fileInfo.Length) bytes"
            Write-Host "Created: $($fileInfo.CreationTime)"

            # Basic PE header check
            $bytes = [System.IO.File]::ReadAllBytes($exe)
            if ($bytes[0] -eq 0x4D -and $bytes[1] -eq 0x5A) {
              Write-Host "Valid PE executable (MZ header found)"
            } else {
              Write-Host "ERROR: Invalid PE header"
              exit 1
            }
          } else {
            Write-Host "ERROR: Executable not found"
            exit 1
          }

      - name: Runtime Test - SVG Loading
        shell: pwsh
        run: |
          Write-Host "Creating test SVG file..."
          $testSvg = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect id="frame" width="100" height="100">
              <animate attributeName="fill" dur="1s" repeatCount="indefinite"
                       values="red;blue;green;red"/>
            </rect>
          </svg>
          "@
          $testSvg | Out-File -FilePath "$env:TEMP\test.svg" -Encoding utf8

          Write-Host "Testing --help flag..."
          $helpOutput = & "build\windows\fbfsvg-player.exe" --help 2>&1
          Write-Host $helpOutput

          Write-Host ""
          Write-Host "Testing --version flag..."
          $versionOutput = & "build\windows\fbfsvg-player.exe" --version 2>&1
          Write-Host $versionOutput

          Write-Host ""
          Write-Host "Running player with benchmark mode..."
          # Run with benchmark flag for 5 frames and exit
          # Use Start-Process with timeout to prevent hangs
          $process = Start-Process -FilePath "build\windows\fbfsvg-player.exe" `
            -ArgumentList "--benchmark=5", "$env:TEMP\test.svg" `
            -PassThru -NoNewWindow

          # Wait up to 30 seconds for process to complete
          $completed = $process.WaitForExit(30000)

          if (-not $completed) {
            Write-Host "WARNING: Player timed out, killing process..."
            $process.Kill()
            exit 1
          }

          $exitCode = $process.ExitCode
          if ($exitCode -eq 0) {
            Write-Host "SUCCESS: Player completed benchmark mode"
          } else {
            Write-Host "FAIL: Player exited with code $exitCode"
            exit 1
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-player
          path: |
            build/windows/fbfsvg-player.exe
            build/windows/SDL2.dll

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [api-compile-test, linux-build, macos-build, macos-x64-build, ios-build, windows-build]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "Build Summary"
          echo "============="
          echo ""
          echo "API Header Test: ${{ needs.api-compile-test.result }}"
          echo "Linux Build: ${{ needs.linux-build.result }}"
          echo "macOS Build: ${{ needs.macos-build.result }}"
          echo "macOS x64 Build: ${{ needs.macos-x64-build.result }}"
          echo "iOS Build: ${{ needs.ios-build.result }}"
          echo "Windows Build: ${{ needs.windows-build.result }}"
          echo ""

          # Note: macos-x64 is skipped (no free x64 runner) - treat skipped as success
          if [ "${{ needs.api-compile-test.result }}" != "success" ] || \
             [ "${{ needs.linux-build.result }}" != "success" ] || \
             [ "${{ needs.macos-build.result }}" != "success" ] || \
             ( [ "${{ needs.macos-x64-build.result }}" != "success" ] && [ "${{ needs.macos-x64-build.result }}" != "skipped" ] ) || \
             [ "${{ needs.ios-build.result }}" != "success" ] || \
             [ "${{ needs.windows-build.result }}" != "success" ]; then
            echo "One or more builds failed!"
            exit 1
          fi

          echo "All builds successful!"
